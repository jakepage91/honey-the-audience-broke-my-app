{{- if .Values.postgresql.seedData }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: seed-script
  namespace: {{ .Values.namespace }}
  labels:
    app: postgresql
data:
  seed.py: |
    #!/usr/bin/env python3
    import os
    import random
    import string
    import sys
    from datetime import datetime, timedelta

    import psycopg2
    from psycopg2.extras import execute_values

    DATABASE_URL = os.getenv("DATABASE_URL")
    TOTAL_ROWS = 500_000
    BATCH_SIZE = 10_000
    KNOWN_CODE = "conf-partner-2026"
    KNOWN_NAME = "SREDay Conference Partner"

    def generate_random_code(length=20):
        chars = string.ascii_lowercase + string.digits
        return ''.join(random.choice(chars) for _ in range(length))

    def generate_random_name():
        prefixes = ["Tech", "Cloud", "Data", "Dev", "Ops", "Infra", "Net", "Code", "App", "Web"]
        suffixes = ["Corp", "Labs", "Systems", "Solutions", "Inc", "Co", "Partners", "Group", "Ltd", "LLC"]
        return f"{random.choice(prefixes)}{random.choice(suffixes)}-{random.randint(1000, 9999)}"

    def random_date():
        start = datetime(2020, 1, 1)
        end = datetime(2025, 12, 31)
        delta = end - start
        random_days = random.randint(0, delta.days)
        return start + timedelta(days=random_days)

    def seed_database():
        print(f"Connecting to database...")
        conn = psycopg2.connect(DATABASE_URL)
        cur = conn.cursor()

        cur.execute("SELECT COUNT(*) FROM referral_partners")
        existing_count = cur.fetchone()[0]

        if existing_count >= TOTAL_ROWS:
            print(f"Database already has {existing_count} rows. Skipping seed.")
            cur.close()
            conn.close()
            return

        if existing_count > 0:
            print(f"Database has {existing_count} rows. Clearing and reseeding...")
            cur.execute("TRUNCATE referral_partners RESTART IDENTITY")
            conn.commit()

        print(f"Seeding {TOTAL_ROWS:,} referral partners...")
        codes_generated = set()
        codes_generated.add(KNOWN_CODE)
        total_inserted = 0

        # Insert all random rows first, then the known code last.
        # This ensures looking up conf-partner-2026 requires a full sequential
        # scan of the table, which exceeds the statement_timeout and triggers
        # the connection leak bug as intended.
        while total_inserted < TOTAL_ROWS - 1:
            batch = []
            batch_target = min(BATCH_SIZE, TOTAL_ROWS - 1 - total_inserted)
            while len(batch) < batch_target:
                code = generate_random_code()
                if code not in codes_generated:
                    codes_generated.add(code)
                    batch.append((code, generate_random_name(), random_date()))

            execute_values(cur, "INSERT INTO referral_partners (code, name, created_at) VALUES %s",
                          batch, template="(%s, %s, %s)")
            conn.commit()
            total_inserted += len(batch)
            print(f"  Inserted {total_inserted:,} / {TOTAL_ROWS:,}")

        execute_values(cur, "INSERT INTO referral_partners (code, name, created_at) VALUES %s",
                      [(KNOWN_CODE, KNOWN_NAME, datetime.now())], template="(%s, %s, %s)")
        conn.commit()
        total_inserted += 1
        print(f"  Inserted {total_inserted:,} / {TOTAL_ROWS:,} (known code last)")

        cur.execute("SELECT COUNT(*) FROM referral_partners")
        final_count = cur.fetchone()[0]
        print(f"Seeding complete. Total rows: {final_count:,}")
        cur.close()
        conn.close()

    if __name__ == "__main__":
        try:
            seed_database()
        except Exception as e:
            print(f"Error: {e}", file=sys.stderr)
            sys.exit(1)
---
apiVersion: batch/v1
kind: Job
metadata:
  name: postgresql-seed
  namespace: {{ .Values.namespace }}
  labels:
    app: postgresql-seed
  annotations:
    "helm.sh/hook": post-install,post-upgrade
    "helm.sh/hook-weight": "5"
    "helm.sh/hook-delete-policy": before-hook-creation
spec:
  ttlSecondsAfterFinished: 600
  backoffLimit: 3
  template:
    metadata:
      labels:
        app: postgresql-seed
    spec:
      restartPolicy: OnFailure
      securityContext:
        runAsNonRoot: true
        runAsUser: 1000
        runAsGroup: 1000
        fsGroup: 1000
        seccompProfile:
          type: RuntimeDefault
      containers:
        - name: seed
          image: python:3.12.8-slim-bookworm
          securityContext:
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: true
            capabilities:
              drop:
                - ALL
          command:
            - /bin/sh
            - -c
            - |
              pip install --quiet psycopg2-binary -t /tmp/packages && \
              PYTHONPATH=/tmp/packages python /scripts/seed.py
          env:
            - name: POSTGRES_USER
              valueFrom:
                secretKeyRef:
                  name: postgresql-credentials
                  key: username
            - name: POSTGRES_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: postgresql-credentials
                  key: password
            - name: POSTGRES_DB
              valueFrom:
                secretKeyRef:
                  name: postgresql-credentials
                  key: database
            - name: DATABASE_URL
              value: "postgresql://$(POSTGRES_USER):$(POSTGRES_PASSWORD)@postgresql:5432/$(POSTGRES_DB)"
          volumeMounts:
            - name: seed-script
              mountPath: /scripts
            - name: tmp
              mountPath: /tmp
          resources:
            requests:
              cpu: "100m"
              memory: "256Mi"
            limits:
              cpu: "500m"
              memory: "512Mi"
      volumes:
        - name: seed-script
          configMap:
            name: seed-script
        - name: tmp
          emptyDir: {}
{{- end }}
